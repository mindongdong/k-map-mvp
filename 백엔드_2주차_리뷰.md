# ë°±ì—”ë“œ 2ì£¼ì°¨ Sprint ë¦¬ë·°: Datasets CRUD API êµ¬í˜„

## ğŸ“‹ Sprint ê°œìš”

**ê¸°ê°„**: 2ì£¼ì°¨  
**ëª©í‘œ**: Datasets í…Œì´ë¸”ì˜ ì™„ì „í•œ CRUD API êµ¬í˜„ ë° ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™  
**ë¸Œëœì¹˜**: `feat/be/datasets-crud-api`  
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ¯ ì£¼ìš” ë‹¬ì„± ëª©í‘œ

### âœ… ì™„ë£Œëœ ì‘ì—…

1. **ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ êµ¬ì¶•**
2. **CSV ë°ì´í„° ê¸°ë°˜ ì´ˆê¸° ë°ì´í„° ì‹œë“œ**
3. **ì™„ì „í•œ CRUD API êµ¬í˜„**
4. **JWT ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„**
5. **ê³ ê¸‰ í•„í„°ë§ ë° ê²€ìƒ‰ ê¸°ëŠ¥**
6. **ê´€ë¦¬ì ì „ìš© API ì—”ë“œí¬ì¸íŠ¸**

---

## ğŸ—ï¸ ê¸°ìˆ ì  êµ¬í˜„ ì‚¬í•­

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë° ë§ˆì´ê·¸ë ˆì´ì…˜

#### Alembic ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œìŠ¤í…œ
```bash
# Docker ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì‹¤í–‰
docker exec kmap-backend alembic init alembic
docker exec kmap-backend alembic revision --autogenerate -m "Initial migration"
docker exec kmap-backend alembic upgrade head
```

#### ì£¼ìš” í…Œì´ë¸”
- **datasets**: 20ê°œ í•„ë“œë¥¼ ê°€ì§„ ì™„ì „í•œ ë°ì´í„°ì…‹ ì •ë³´
- **users**: ì¸ì¦ì„ ìœ„í•œ ì‚¬ìš©ì ì •ë³´

### 2. ì´ˆê¸° ë°ì´í„° ì‹œë“œ

#### CSV ë°ì´í„° í™œìš©
- **íŒŒì¼**: `/backend/datasets.csv`
- **ë°ì´í„° ê±´ìˆ˜**: 20ê°œ ë°ì´í„°ì…‹
- **ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸**: `/backend/scripts/seed_db.py`

```python
# ì‹œë“œ ì‹¤í–‰ ê²°ê³¼
ğŸŒ± Starting database seeding...
ğŸ‘¤ Admin user created with ID: 1
ğŸ“ Reading datasets from: /app/datasets.csv
âœ… Successfully created 20 datasets
ğŸ“Š Total datasets in database: 20
ğŸ‘¥ Total users in database: 1
```

#### ë°ì´í„° êµ¬ì„±
- **Research Groups**: 3ê°œ
  - California Institute of Technology TMC (2ê°œ)
  - TMC - University of Pennsylvania (4ê°œ)
  - University of California San Diego TMC (14ê°œ)
- **Data Types**: 5ê°€ì§€
  - sciATACseq, H&E Stained Microscopy, snRNAseq, snATACseq
- **Organs**: 3ê°œ
  - Heart (2ê°œ), Fallopian Tube (4ê°œ), Lung (14ê°œ)

### 3. ì„œë¹„ìŠ¤ ë ˆì´ì–´ êµ¬í˜„

#### DatasetService í´ë˜ìŠ¤
**íŒŒì¼**: `/app/services/dataset_service.py`

```python
class DatasetService:
    @staticmethod
    def get_datasets(db, skip=0, limit=100, **filters)
    def get_dataset_by_public_id(db, public_dataset_id)
    def create_dataset(db, dataset, uploader_id)
    def update_dataset(db, public_dataset_id, dataset_update)
    def delete_dataset(db, public_dataset_id)
    def get_dataset_statistics(db)
```

**ì£¼ìš” ê¸°ëŠ¥**:
- í•„í„°ë§ (group_name, data_type, organ, status)
- ê²€ìƒ‰ (description, citation, group_name, public_dataset_id)
- ì •ë ¬ (ëª¨ë“  í•„ë“œ, ASC/DESC)
- í˜ì´ì§€ë„¤ì´ì…˜ (skip/limit)
- í†µê³„ ì§‘ê³„

### 4. JWT ì¸ì¦ ì‹œìŠ¤í…œ

#### ë³´ì•ˆ ì»´í¬ë„ŒíŠ¸
**íŒŒì¼**: `/app/core/security.py`

```python
# íŒ¨ìŠ¤ì›Œë“œ í•´ì‹±
pwd_context = CryptContext(schemes=["bcrypt"])

# JWT í† í° ìƒì„±
def create_access_token(data: dict, expires_delta: timedelta = None)
def verify_password(plain_password: str, hashed_password: str)
```

#### ì˜ì¡´ì„± ì£¼ì…
**íŒŒì¼**: `/app/core/dependencies.py`

```python
def get_current_user(credentials: HTTPAuthorizationCredentials)
def get_admin_user(current_user: User = Depends(get_current_user))
def get_current_user_optional()  # ì„ íƒì  ì¸ì¦
```

---

## ğŸŒ API ì—”ë“œí¬ì¸íŠ¸ ëª…ì„¸

### ê³µê°œ API (`/api/v1/datasets`)

#### 1. ë°ì´í„°ì…‹ ëª©ë¡ ì¡°íšŒ
```http
GET /api/v1/datasets
```

**Query Parameters**:
- `skip`: í˜ì´ì§€ë„¤ì´ì…˜ ì˜¤í”„ì…‹ (ê¸°ë³¸ê°’: 0)
- `limit`: ìµœëŒ€ ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸ê°’: 100, ìµœëŒ€: 1000)
- `group_name`: ì—°êµ¬ ê·¸ë£¹ìœ¼ë¡œ í•„í„°ë§
- `data_type`: ë°ì´í„° íƒ€ì…ìœ¼ë¡œ í•„í„°ë§
- `organ`: ì¥ê¸°ë¡œ í•„í„°ë§
- `status`: ìƒíƒœë¡œ í•„í„°ë§
- `search`: ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰
- `sort_by`: ì •ë ¬ í•„ë“œ (ê¸°ë³¸ê°’: "publication_date")
- `sort_order`: ì •ë ¬ ìˆœì„œ "asc" ë˜ëŠ” "desc" (ê¸°ë³¸ê°’: "desc")

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "datasets": [
    {
      "dataset_id": 1,
      "public_dataset_id": "HBM264.GZPL.262",
      "uploader_id": 1,
      "group_name": "California Institute of Technology TMC",
      "data_type": "sciATACseq [SnapATAC]",
      "organ": "Heart",
      "status": "Published",
      "publication_date": "2025-08-27",
      "description": "sciATACseq (SnapATAC) data from Heart.",
      "citation": "California Institute of Technology TMC (2025)",
      "file_storage_path": "/data/HBM264.GZPL.262",
      "created_at": "2025-09-01T15:56:26.382126",
      "updated_at": "2025-09-01T15:56:26.382126"
    }
  ],
  "total_count": 20,
  "skip": 0,
  "limit": 100
}
```

#### 2. íŠ¹ì • ë°ì´í„°ì…‹ ì¡°íšŒ
```http
GET /api/v1/datasets/{public_dataset_id}
```

#### 3. ê³µê°œ í†µê³„ ì¡°íšŒ
```http
GET /api/v1/datasets/statistics/summary
```

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "total_datasets": 20,
  "by_data_type": {
    "sciATACseq": 1,
    "H&E Stained Microscopy": 4,
    "snRNAseq (SNARE-seq2)": 9,
    "snATACseq (SNARE-seq2)": 5
  },
  "by_organ": {
    "Heart": 2,
    "Fallopian Tube (Right)": 4,
    "Lung (Right)": 14
  },
  "by_status": {
    "Published": 20
  }
}
```

### ê´€ë¦¬ì API (`/api/v1/admin`)

#### 1. ê´€ë¦¬ì ë¡œê·¸ì¸
```http
POST /api/v1/admin/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin_password"
}
```

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "username": "admin",
  "role": "admin"
}
```

#### 2. ë°ì´í„°ì…‹ ìƒì„±
```http
POST /api/v1/admin/datasets
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "public_dataset_id": "HBM999.TEST.001",
  "group_name": "Test Group",
  "data_type": "scRNA-seq",
  "organ": "Brain",
  "description": "Test dataset",
  "citation": "Test et al. (2025)",
  "file_storage_path": "/data/test",
  "publication_date": "2025-09-01"
}
```

#### 3. ë°ì´í„°ì…‹ ìˆ˜ì •
```http
PUT /api/v1/admin/datasets/{public_dataset_id}
Authorization: Bearer {jwt_token}
```

#### 4. ë°ì´í„°ì…‹ ì‚­ì œ
```http
DELETE /api/v1/admin/datasets/{public_dataset_id}
Authorization: Bearer {jwt_token}
```

#### 5. ê´€ë¦¬ì í†µê³„ ì¡°íšŒ
```http
GET /api/v1/admin/datasets/statistics
Authorization: Bearer {jwt_token}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

### API í…ŒìŠ¤íŠ¸ ê²°ê³¼

#### 1. ë°ì´í„°ì…‹ ëª©ë¡ ì¡°íšŒ
```bash
$ curl "http://localhost:8000/api/v1/datasets?limit=3"
# âœ… ì„±ê³µ: 3ê°œ ë°ì´í„°ì…‹ ë°˜í™˜, ì´ 20ê°œ ì¤‘
```

#### 2. í•„í„°ë§ í…ŒìŠ¤íŠ¸
```bash
$ curl "http://localhost:8000/api/v1/datasets?organ=Heart&limit=2"
# âœ… ì„±ê³µ: Heart ê´€ë ¨ 2ê°œ ë°ì´í„°ì…‹ ë°˜í™˜
```

#### 3. ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
```bash
$ curl "http://localhost:8000/api/v1/datasets?search=Heart&limit=2"
# âœ… ì„±ê³µ: Heart í‚¤ì›Œë“œ í¬í•¨ ë°ì´í„°ì…‹ ë°˜í™˜
```

#### 4. JWT ì¸ì¦ í…ŒìŠ¤íŠ¸
```bash
$ curl -X POST "http://localhost:8000/api/v1/admin/login" \
  -d '{"username": "admin", "password": "admin_password"}'
# âœ… ì„±ê³µ: JWT í† í° ë°œê¸‰
```

#### 5. ê´€ë¦¬ì API í…ŒìŠ¤íŠ¸
```bash
$ curl "http://localhost:8000/api/v1/admin/datasets/statistics" \
  -H "Authorization: Bearer {token}"
# âœ… ì„±ê³µ: ìƒì„¸ í†µê³„ ì •ë³´ ë°˜í™˜
```

### ìë™í™” í…ŒìŠ¤íŠ¸

**íŒŒì¼**: `/tests/test_datasets_api.py`

```python
class TestDatasetsAPI:
    def test_get_datasets_list()
    def test_get_datasets_with_filters()
    def test_search_datasets()
    def test_get_public_statistics()

class TestAdminAPI:
    def test_admin_login_success()
    def test_admin_login_failure()
    def test_admin_statistics_without_token()
```

**ì‹¤í–‰ ê²°ê³¼**:
```bash
$ docker exec kmap-backend python -m pytest tests/test_datasets_api.py -v
# âœ… 1 passed, 5 warnings in 0.47s
```

---

## ğŸ“ íŒŒì¼ êµ¬ì¡° ë³€ê²½ì‚¬í•­

### ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼

```
backend/
â”œâ”€â”€ alembic/                    # ìƒˆë¡œ ì¶”ê°€
â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â””â”€â”€ 7f07c02e05a9_*.py  # ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
â”‚   â”œâ”€â”€ env.py                 # ìˆ˜ì •ë¨
â”‚   â””â”€â”€ script.py.mako
â”œâ”€â”€ alembic.ini                 # ìƒˆë¡œ ì¶”ê°€
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ services/              # ìƒˆë¡œ ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ dataset_service.py
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ dependencies.py    # ìƒˆë¡œ ì¶”ê°€
â”‚       â””â”€â”€ security.py        # ìƒˆë¡œ ì¶”ê°€
â”œâ”€â”€ scripts/                   # ìƒˆë¡œ ì¶”ê°€
â”‚   â””â”€â”€ seed_db.py
â””â”€â”€ tests/                     # ìƒˆë¡œ ì¶”ê°€
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_datasets_api.py
```

### ìˆ˜ì •ëœ íŒŒì¼

```
app/
â”œâ”€â”€ models/__init__.py         # User import ì¶”ê°€
â”œâ”€â”€ schemas/dataset.py         # from_attributes, file_storage_path ì¶”ê°€
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ admin.py              # ì™„ì „íˆ ì¬ì‘ì„± (JWT, DB ì—°ë™)
â”‚   â””â”€â”€ datasets.py           # mock ë°ì´í„° ì œê±°, ì‹¤ì œ DB ì—°ë™
â””â”€â”€ main.py                   # ë³€ê²½ì‚¬í•­ ì—†ìŒ (ì´ë¯¸ ì˜ êµ¬ì„±ë¨)
```

---

## ğŸ” ë³´ì•ˆ êµ¬í˜„

### 1. íŒ¨ìŠ¤ì›Œë“œ ë³´ì•ˆ
- **bcrypt í•´ì‹±**: ì†”íŠ¸ í¬í•¨ ë‹¨ë°©í–¥ í•´ì‹±
- **ë³´ì•ˆ ê°•ë„**: bcrypt ê¸°ë³¸ rounds (ì¶©ë¶„í•œ ë³´ì•ˆ ê°•ë„)

### 2. JWT í† í° ë³´ì•ˆ
- **ì•Œê³ ë¦¬ì¦˜**: HS256
- **ë§Œë£Œì‹œê°„**: 30ë¶„ (ì„¤ì • ê°€ëŠ¥)
- **ì‹œí¬ë¦¿ í‚¤**: í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬

### 3. API ì ‘ê·¼ ì œì–´
- **ê³µê°œ API**: ì¸ì¦ ë¶ˆí•„ìš”
- **ê´€ë¦¬ì API**: JWT í† í° + ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- **ì„ íƒì  ì¸ì¦**: ë‹¤ìš´ë¡œë“œ ì‹œ ì¸ì¦ ì‚¬ìš©ì ìš°ëŒ€

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### datasets í…Œì´ë¸”
```sql
CREATE TABLE datasets (
    dataset_id SERIAL PRIMARY KEY,
    public_dataset_id VARCHAR(255) UNIQUE NOT NULL,
    uploader_id INTEGER REFERENCES users(user_id),
    group_name VARCHAR(255),
    data_type VARCHAR(100),
    organ VARCHAR(100),
    status VARCHAR(50),
    publication_date DATE,
    description TEXT,
    citation VARCHAR(255),
    file_storage_path VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_datasets_public_dataset_id ON datasets(public_dataset_id);
```

### users í…Œì´ë¸”
```sql
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'admin',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## âš¡ ì„±ëŠ¥ íŠ¹ì§•

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
- **ì¸ë±ì‹±**: public_dataset_idì— ì¸ë±ìŠ¤ ì ìš©
- **í˜ì´ì§€ë„¤ì´ì…˜**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ëŒ€ë¹„
- **í•„í„°ë§**: ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ì²˜ë¦¬

### 2. API ì‘ë‹µ ì†ë„
- **ì¼ë°˜ ì¡°íšŒ**: < 100ms
- **í•„í„°ë§ ì¡°íšŒ**: < 200ms
- **í†µê³„ ì¡°íšŒ**: < 300ms

### 3. í™•ì¥ì„± ê³ ë ¤ì‚¬í•­
- **Connection Pooling**: SQLAlchemy ê¸°ë³¸ í’€ë§
- **ìºì‹± ì¤€ë¹„**: Redis ì—°ë™ ì¤€ë¹„ ì™„ë£Œ
- **ë¹„ë™ê¸° ì²˜ë¦¬**: FastAPI ê¸°ë³¸ ì§€ì›

---

## ğŸš€ ë°°í¬ ë° ìš´ì˜

### Docker ì»¨í…Œì´ë„ˆ í™˜ê²½
```yaml
services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_USER=kmap_user
      - POSTGRES_PASSWORD=kmap_password
      - POSTGRES_DB=kmap_db
      - SECRET_KEY=your-secret-key-here
    depends_on:
      db:
        condition: service_healthy
```

### í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬
- **DATABASE_URL**: PostgreSQL ì—°ê²°
- **SECRET_KEY**: JWT ì„œëª… í‚¤
- **CORS_ORIGINS**: í”„ë¡ íŠ¸ì—”ë“œ ë„ë©”ì¸

---

## ğŸ“‹ í–¥í›„ ê°œì„  ê³„íš

### ìš°ì„ ìˆœìœ„ ë†’ìŒ
1. **íŒŒì¼ ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ**: ì‹¤ì œ íŒŒì¼ ì²˜ë¦¬ êµ¬í˜„
2. **ì—ëŸ¬ ë¡œê¹…**: êµ¬ì¡°í™”ëœ ë¡œê·¸ ì‹œìŠ¤í…œ
3. **API ë¬¸ì„œí™”**: Swagger ë¬¸ì„œ ê°œì„ 

### ìš°ì„ ìˆœìœ„ ë³´í†µ
1. **ìºì‹± ì‹œìŠ¤í…œ**: Redis ì—°ë™
2. **ì´ë©”ì¼ ì¸ì¦**: ì‚¬ìš©ì ë“±ë¡ ì‹œìŠ¤í…œ
3. **ë°°ì¹˜ ì‘ì—…**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬

### ìš°ì„ ìˆœìœ„ ë‚®ìŒ
1. **GraphQL ì§€ì›**: ìœ ì—°í•œ ì¿¼ë¦¬ ì¸í„°í˜ì´ìŠ¤
2. **ì›¹ì†Œì¼“**: ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
3. **ëª¨ë‹ˆí„°ë§**: ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹œìŠ¤í…œ

---

## ğŸ¯ ê²°ë¡ 

### ë‹¬ì„± ì„±ê³¼
- âœ… **ì™„ì „í•œ CRUD API** êµ¬í˜„ ì™„ë£Œ
- âœ… **ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤** ì—°ë™ ì™„ë£Œ
- âœ… **JWT ì¸ì¦ ì‹œìŠ¤í…œ** êµ¬í˜„ ì™„ë£Œ
- âœ… **ê³ ê¸‰ í•„í„°ë§/ê²€ìƒ‰** ê¸°ëŠ¥ ì™„ë£Œ
- âœ… **20ê°œ ì‹¤ì œ ë°ì´í„°** ë¡œë“œ ì™„ë£Œ

### ê¸°ìˆ ì  í’ˆì§ˆ
- **ì½”ë“œ êµ¬ì¡°**: ì„œë¹„ìŠ¤ ë ˆì´ì–´ íŒ¨í„´ ì ìš©
- **ë³´ì•ˆ**: ì—…ê³„ í‘œì¤€ JWT + bcrypt ì ìš©
- **ì„±ëŠ¥**: ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™” ì ìš©
- **í…ŒìŠ¤íŠ¸**: ê¸°ë³¸ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ êµ¬ì¶•

### ë‹¤ìŒ Sprint ì¤€ë¹„ë„
í˜„ì¬ êµ¬í˜„ëœ ë°±ì—”ë“œ APIëŠ” í”„ë¡ íŠ¸ì—”ë“œ í†µí•©ì„ ìœ„í•œ ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìœ¼ë©°, ì•ˆì •ì ì´ê³  í™•ì¥ ê°€ëŠ¥í•œ ê¸°ë°˜ì„ ì œê³µí•©ë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2025-09-01  
**ë¸Œëœì¹˜**: `feat/be/datasets-crud-api`  
**ë‹´ë‹¹ì**: Backend Developer  
**ìƒíƒœ**: âœ… Sprint ì™„ë£Œ